# IOの問題

計算の速度が思うように出ない場合、非常に多くのケースでディスクIOが原因となっています。
特に、並列に大量の計算が走る場合にはIOがボトルネックになりがちです。

複数のプログラムが同時に実行中の場合、以下のような階層で
プロセス間で計算機資源の奪い合いが発生します。

| 装置 | 起きる競合 |
| ------------- | ------------- |
| CPU | コンテキストスイッチ |
| キャッシュメモリ | スラッシング |
| メインメモリ | スラッシング(スワッピング) |
| HDD | ディスクスラッシング |

これらの競合は、単純にその階層内での競合で収まればまだ良いのですが、
キャッシュの競合はキャッシュのヒットミスを多発させてメインメモリへのアクセスを増やし、
メインメモリの競合はメモリ容量不足を招いて、ディスクへのスワッピングを増やします。

そして最悪の場合、最も遅いデバイスであるディスクに最終的には競合のしわ寄せが
集まってしまいます。

現代のXeonなどのCPUでは、L3キャッシュまではCPUに内蔵されていて、
40MBほどのL3キャッシュに収まる規模の計算であれば、非常に高速に
高速に動作します。ところがそれで収まらない場合は、キャッシュよりも
10倍程度遅いメインメモリも使用して計算するので、計算速度は
やや低下します。

そして、メモリに無いデータをディスクから読み出す場合は、ディスクは
メモリよりも100倍以上遅いことも多いので、計算も最悪100倍以上も
遅くなってしまいます。

このため、科学計算では100倍もの長い時間を待つくらいなら
計算をいったん失敗させて、計算方法を修正するなどしてメインメモリで
足りる範囲の計算として構成しなおした方が現実的であることから、スワップ(仮想記憶)の
機能をオフにしておくことも多いのです。

## 同時アクセス数を制御する方法

同時にアクセスするプログラム数やスレッド数を制御する方法は様々な方法があるので、
適した方法を見つけてください。

### ジョブスケジューラを使う
大規模な並列計算機や、グリッドの環境では、SGEやSlurm, PBSなどのジョブスケジューラと
呼ばれるミドルウェアの利用が推奨されていたり、義務付けられているかと思います。

ジョブスケジューラは、複数の計算機を束ねて、どこでどのくらいのCPUやメモリを
使って計算するかをユーザの要求に従って、バランスを取りながら順番に
処理してくれるシステムです。大量に計算ジョブを投入すると、待たされることには
なりますが、処理が集中してかえって遅くなるような事態は起きません。

### スレッドプーリング
Webサーバやデータベースでは、それらのサーバソフトウェアの起動時に
スレッドプールと呼ばれる何個かのスレッドが待機するプールを
作ります。クライアントからのリクエストが来ると、スレッドプールから
スレッドが払い出されて処理を行い、終わるとプールに戻されます。

例えば、4コアのサーバならスレッドプールのサイズを4スレッドにしておけば
ひどい競合は起きません。

Javaなどの言語では標準ライブラリにスレッドプールを簡単に作れる機能が
備わっているので、そういったものを利用したプログラムを書くこともできます。

### 手動で制御
手元で並列に処理したい場合に、使用するプロセス数を指定できる方法がいくつかあります。
- make
  昔からある方法で、Makefile内で処理を複数のターゲットに分けておきmake -j 8 などとすると
  同時に8個の処理が並列に行われます
- xargs, GNU parallel
  コマンドラインで並列に処理したい場合には、これらは大変便利です。

# 並列なIOへの耐性
上述のような方法で、並列度は制御できるとして、IOを並列に高速に行える方法についても
紹介しておきたいと思います。

単体のHDDについては、どのようなものかご存じかと思いますが、もし知らない方は
構造や性能等について、少し調べてみてください。

一般的な単体のHDDは、金属の円盤を何層か重ねた構造になっていて、
それを針で読み取る仕組になっています。このレコードのような
制御のため、ディスク上で連測しているデータの読み出しは高速ですが、
針が飛び飛びにアクセスしなければならないような、いわゆる
ランダムアクセスの性能は非常に低い装置です。

## RAID
RAIDは、RAID1やRAID5はディスクの故障に備えて冗長化のために用いられることが多いですが、
HDDを複数個束ねて高速にアクセスできるようにする用途ではRAID0や、RAID10もよく
利用されます。また、RAID5,RAID6もディスク本数が多い場合には高速になり、巨大な
ボリュームを高速に使いたい場合にもよく用いられます。

RAIDはデータを分散して読み書きしたり、その過程でパリティの計算を大量に行うので、
RAIDコントローラと呼ばれる半導体チップを搭載した拡張カードなどが
よく用いられます。この半導体チップの性能はピンからキリまであり、
安価なものはあまり機能がないので、計算機本体側のCPUを使用して
計算するものもあり、ソフトウェアRAIDと呼ばれます。

ハードウェアRAIDの方が一般的にはスループット(処理性能)が大きく
負荷にも強いですが、価格もそれなりに高くなります。

RAIDを用いずに外付けの単体ディスクを利用する場合などにも、
それぞれのデバイス向けには(IO)コントローラと呼ばれる半導体部品が
使われており、アクセスの速度や並列なアクセスへの耐性は
それらに依存しています。

## SSD

## RAMDISK
