# mpstat

昔の計算機はCPUが一個しか搭載されておらず、そのCPUも1コアしか載っていませんでした。
しかし現代ではパソコンでも8コア以上の機種が一般的でサーバにおいては
40コア以上のものがたくさんあります。

それらのコアが効率的に利用されているか確認するには、mpstatが便利です。

mpstatは、sysstatというパッケージに入っているのですが、デフォルトではインストールされていない
場合もあるので、無かった場合は下記のようなコマンドでインストールしてください。

Ubuntu等
```
apt-get install sysstat
```
RedHat等
```
dnf install sysstat
```

mpstatで全CPUの状況を1秒間隔で表示するには以下のようなコマンドでできます。終了する場合はCtrl-Cで終了してください。
```
mpstat -P ALL 1
```
72コアの計算機で、何も計算していなかった場合、以下のように表示されます。
```
05:09:39 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
05:09:40 PM  all    0.01    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.99
05:09:40 PM    0    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM    1    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM    2    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM    3    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM    4    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM    5    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM    6    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM    7    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM    8    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
(略)
05:09:40 PM   62    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM   63    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM   64    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM   65    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM   66    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM   67    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM   68    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM   69    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM   70    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
05:09:40 PM   71    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
```

ここで72コアの状況が表示されましたが、何も計算していない場合はこのように%idleが100%となり、
CPU負荷の%userと%sysは0%になります。

たとえば、4スレッドで動作するプログラムを1個実行した場合、理想的に計算が進行すると
%userが100となる行がどこかに計4行表示されることになります。

8スレッド使うbwa memを9個同時に実行したらどうなるでしょうか？
理想的に計算機を使い尽くすことができれば、8 x 9 = 72なので72コアが
100%になるかもしれません。

おそらく実際にはそうはならず、bwaのようなプログラムは数百GBの入力ファイルを読み込んで
数GBのファイルを出力するので、9個も同時に実行するとHDDの入出力(I/O)が追い付かずに
%iowaitが上がってきて%usrは下がってしまうでしょう。

%iowaitが10%になってくると、計算時間のうち10%程度は入出力待ちで計算機が休んでいることになるので、
%iowaitが1桁台くらいに収まる程度に負荷を抑制した方がよいでしょう。iowaitが少しでも上がるという
ことはIOに競合が起きていることを意味するので、特にHDDのように機械的に動作する部品が
競合状態に晒されるとシーク(HDDの針の移動)などの無駄な動きが増え、性能が大幅に低下する可能性があります。
SSDのような半導体のみで構成される記憶媒体の場合は競合状態の影響はいくらか軽減されるかもしれません。

iowaitが上がりやすい環境でプログラムを更に効率的に動作させたい場合は、HDDなどの補助記憶装置の高速化や
SSDやRAID装置の導入などの改善を検討してください。
