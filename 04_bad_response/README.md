# レスポンスが悪い

大きな計算をしていると、計算機のレスポンスが悪くなり、lsなどのコマンドを実行しても
応答がすぐには返ってこなかったりする場合があります。計算に負荷をかけている
心当たりがある場合は、```mpstat -P ALL 1```で確認してみましょう。

また、負荷はかかっていないはずなのにレスポンスの悪いコマンドがある場合は、
/以下にアクセスできないボリュームがマウントされていないか確認してみてください。
これについては後述します。

## 健全に計算機は動作しているか

不健全な動作の兆候としては、mpstatの結果のうち%sysや%iowaitが上がっている場合があります。
目安としてこれらが10%以上になっていると、コマンドを実行してもレスポンスが悪いと体感で分かると思います。

iowaitが高い場合には、同時に実行しているプログラムを終了させるかkill -STOPなどで
休止させましょう。ioniceで一部のプログラムの優先度を下げるのもよいでしょう。

一方厄介なのは%sysが高い場合です。
%sysはカーネルモードの動作時間の割合を示します。
> UNIX系OSの基礎知識として、カーネルモードとユーザーモードというものがありますが、もしご存じでない場合は教科書等をあたってみてください。

科学計算のいわゆる「計算」というのは、四則演算などの数値計算やデータのやりくりなどが主ですが、それらはユーザー用の空間、ユーザーランドで
実行され、その所要時間は%userに出てきます。一方、その過程でメモリの確保や解放、ソケットの開け閉め、プロセスのフォーク等を
行なう場合はOSのカーネルにシステムコールを発行してOSにそれらの作業をさせるので、その時間は%sysとして出てきます。

## 忙しすぎるカーネル
ではなぜ、カーネルがそのように忙しくなってしまうのでしょうか？

これにはいくつかの原因があります。
1. プログラムの作り方に問題がある
   - 外部プログラムの大量呼び出し(プロセスのフォークの大量発行)
   - 巨大なメモリの要求
   - 高頻度なメモリの要求と解放の繰り返し
2. 想定されていない環境での利用
   - NUMA環境(1台の計算機内部で複数のブロックに分かれている)
   - メニーコアCPUの環境
3. 扱うデータに問題がある
   - 巨大ファイルの入出力
   - データの性質によって引き起こされる１のような状況
4. 故障
   - ハードウェアの故障で起こる場合もあります

### プログラムの作り方に問題がある場合
#### 外部プログラムの大量呼び出し
外部プログラムの大量呼び出しのような設計は職業開発者は行いませんが、勉強不足の学生が
書いた研究用コードなどに散見されたり、職業開発者でも不具合のあるコードを実行すると
起こることがあります。データのソートなどは各プログラミング言語に関数が用意されていますが、
それを知らない人はデータをいったんファイルに書き出してsortコマンドでソートしたりするので、
この問題の予防に必要なのは、標準APIなどのプログラミング教育です。

疑わしいプログラムが特定できている場合はstraceなどで詳細な状況が判別できるかもしれません。

### 巨大なメモリの要求
順調に失敗すればプログラムはメモリ不足で即座に異常終了しますが、仮想メモリが割り当てられて
しまった場合にはページフォルトやスワッピングを繰り返してシステムの負荷が高くなり、HDDに
スワップアウトすれば計算は継続できるので、なかなか異常終了しないことがあります。
予防策としては、仮想メモリをOSに設定しないという方法がよく取られます。
> サーバの用途が科学計算以外の一般的な用途の場合は、できるだけサーバのプログラムを異常終了させたく
> ない(サービスを停止させたくない)のでスワップを設定して、自動的な回復を待ちます

また、NUMAノードのような構成になっている計算機ではプログラムの使用メモリが複数のノードに
またがってしまった場合はsoft page faultを頻発させ、OS全体の性能を大幅に低下させることがあります。
プログラム達の使用メモリがそれぞれどこか1個のNUMA node内で収まるように、同時実行数を調節したり
プログラミング言語の処理系がNUMAに非対応の場合はnumactlの利用を検討してください。
> javaはデフォルトでNUMAのローカルなメモリしか使用しないので、numactl不要でも安全です

使用中の計算機のNUMA構成を知りたい場合は、numastatコマンドでNUMAノード数や
各ノードのメモリ容量、NUMAのヒットミス数を確認できます。

またメモリ不足対策に代用としてファイルを使用しているような初歩的なプログラムでは再入可能でなかったり
再実行可能ではない処理が含まれる場合もあるので、中間ファイルは毎回消すなどの注意が必要です。

### 高頻度なメモリの要求と解放の繰り返し
これはプログラムの作りが悪いと発生する現象なので、ユーザ側でできることはあまりないのですが、
プログラムの開発者が想定していなかったような大量の入力データを読み込ませたり、
組み合わせ爆発を起こすようなパラメータを与えた場合に起こりえます。特に計算のスケールを
ごく小規模なものから大幅に拡大した場合などに、マルチスレッド化等もあいまってこのような
問題は起きやすいようです。

予め問題発生が予想できる場合は、C/C++ではメモリをまとめて確保してプールしたり、JavaのようにGCの処理が
重い場合はJavaの採用は避けるなどの対策があります。

## 想定されていない環境での利用
### NUMA環境
現在のXeon用の複数ソケットを備えたサーバなどNUMA構成の機種が多くありますが、古い計算機や
PCは今でも1ソケットの機種が多く使用されています。

PC上で開発したプログラムの中には、PCの搭載コア数を自動的に取得して全コアを
使用してマルチスレッドで動作するようなものがありますが、NUMA構成の場合は
大量のページフォルトを起こしたりします。

PC上で開発されたプログラムは、大型の計算機での利用は想定されていないかもしれないという
認識で注意して利用してください。

### メニーコアCPUの環境
たくさんのコアを利用できると計算は捗りそうなものですが、実際に数十コアの計算機で実行すると
メモリ不足を引き起こしたり、IOが競合したりします。また、1コアあたりのキャッシュ容量も
小さいケースがあるので、むやみに全部をマルチスレッドで使い尽くすのではなく、バランスの
取れたプロセス数やスレッド数に抑える必要があります。

特に何も判断材料がない場合はアムダールの法則にしたがい、1プロセスあたり最大10スレッドまでとし、
それをいくつか走らせてみるのがよいでしょう。厳密に最大の性能を引き出したい場合にはプロファイラなどの
利用を検討してください。

アムダールの法則(Wikipedia):
https://ja.wikipedia.org/wiki/%E3%82%A2%E3%83%A0%E3%83%80%E3%83%BC%E3%83%AB%E3%81%AE%E6%B3%95%E5%89%87

## 扱うデータに問題がある
### 巨大ファイルの入出力
ここで言う巨大というサイズは、100GB以上のファイルです。一般的なプログラミング言語に用意されている
入出力ストリームを使えば、限られたメモリでも大容量のファイルを扱うことは全く問題ないのですが、
問題はLinuxのOS側にあります。

バッファキャッシュはI/Oの高速化のために、ディスクから読み取られたデータブロックを
一時的にメモリに保存する仕組みです。Linuxは効率化のために読んでいるファイルを先行して読み込んで
メモリ上にキャッシュしようとしてくれますが、これが100GB超のファイルを何個も同時に
アクセスしているとpage faultが多発してシステムのパフォーマンスが大幅に低下するケースがあります。

もし、大容量のファイルを複数開いている場合には、そのようなプログラムの同時実行数を減らしてみてください。

### データの性質によって引き起こされる１のような状況
入力データが非常に多かったり、データ内部に自己矛盾や循環があったり、あるいは組合せ爆発のような
状況や、巨大な疎な行列になってしまう場合などに、使用メモリ容量が爆発したり、巨大なIOを
発生させてシステムがストールする場合もあります。
